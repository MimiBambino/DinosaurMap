var map,geoCoder,person=!1,Dino=function(e){this.name=e.name,this.continents=ko.observableArray(e.continents),this.locations=ko.observableArray(e.latLongs),this.food=ko.observable(e.food),this.description=ko.observable(e.description),this.markers=ko.observableArray(),this.infoWindow=ko.observable(),this.imageArray=ko.observableArray(),this.icon=ko.computed(function(){return"carnivore"===this.food()?"img/tRex.png":"omnivore"===this.food()?"img/blueDino41.png":"herbivore"===this.food()?"img/plantEaterSm.png":void 0},this)},ViewModel=function(){var e=this;e.startLoc=new google.maps.LatLng(33.5,7.6),e.locationInstruction=ko.observable(!1),e.filterDinoInstruction=ko.observable(!1),e.dinoListInstruction=ko.observable(!1),e.showLegend=ko.observable(!1),e.listVisible=ko.observable(!0),e.search=!1,e.activeInfowindow=ko.observable(),e.init=function(){google.maps.event.addDomListener(window,"load",e.initMap)},e.initMap=function(){var o=new google.maps.StyledMapType(View.bluishMapStyle,{name:"Bluish Map"});google.maps.visualRefresh=!0;var i={center:e.startLoc,zoom:3,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.TERRAIN,"new_bluish_style"]},maxZoom:12,minZoom:3},n=document.getElementById("mapDiv");map=new google.maps.Map(n,i),map.mapTypes.set("new_bluish_style",o),map.setMapTypeId("new_bluish_style"),e.fetchFirebase(),e.locationInstruction(!0)},e.firebaseData={},e.fetchFirebase=function(){var o=new Firebase("https://intense-inferno-1224.firebaseio.com/");o.on("value",function(o){e.firebaseData=o.val();var i=e.firebaseData.dinos;e.setDinoList(i)})},e.dinoList=ko.observableArray(),e.setDinoList=function(o){o.forEach(function(o){e.dinoList().push(new Dino(o))}),e.createDinoMarkers()},e.carnivoreMarkers=ko.observableArray(),e.omnivoreMarkers=ko.observableArray(),e.herbivoreMarkers=ko.observableArray(),e.createDinoMarkers=function(){for(var o=e.dinoList(),i=0;i<o.length;i++)for(var n=o[i],a=0;a<n.locations().length;a++){var r=n.icon(),t=n.locations()[a][0],s=n.locations()[a][1],l=new google.maps.Marker({map:map,position:{lat:t,lng:s},icon:r,title:n.name,visible:!1});"carnivore"===n.food()?e.carnivoreMarkers().push(l):"herbivore"===n.food()?e.herbivoreMarkers().push(l):"omnivore"===n.food()&&e.omnivoreMarkers().push(l),n.markers().push(l)}e.createInfoWindows()},e.createInfoWindows=function(){for(var o=0,i=e.dinoList(),n=i.length;n>o;o++){var a=new google.maps.InfoWindow({content:"",title:i[o].name});i[o].infoWindow(a),e.dinoDataRequest(a);for(var r=0,t=i[o].markers(),s=t.length;s>r;r++){var l=t[r];google.maps.event.addListener(l,"click",function(o,i){return function(){e.activeInfowindow()&&e.activeInfowindow().close(),i.open(map,o),map.panTo(o.position),e.activeInfowindow(i)}}(l,a))}}},e.dinoDataRequest=function(e){var o="http://en.wikipedia.org/w/api.php?action=query&prop=extracts&format=json&exintro=&titles=",i=e.title;"Tyrannosaurus Rex"===i?i="Tyrannosaurus":("Saturnalia"===i||"Balaur"===i)&&(i+="_(dinosaur)"),o+=i,$.ajax({url:o,xhrFields:{withCredentials:!0},dataType:"jsonp",success:function(o){var n=Object.keys(o.query.pages),a=parseInt(n[0],10),r=o.query.pages[a].extract.substring(0,300);e.setContent("<div class='infoWindow'><h3>Hi, my name is <strong>"+e.title+"</strong>!</h3></div><div>"+r+"...</p></div><div>For more see: <a href='http://www.wikipedia.org/wiki/"+i+"' target='_blank'>Wikipedia</a></div>")},type:"GET",headers:{"Api-User-Agent":"Cynthia O'Donnell: mimibambino@gmail.com","Access-Control-Allow-Origin":!0}})},e.location=ko.observable(""),e.getLocation=ko.computed(function(){geocoder=new google.maps.Geocoder,geocoder.geocode({address:e.location()},function(o,i){if(i===google.maps.GeocoderStatus.OK){person&&personMarker.setMap(null),e.search===!1&&e.filterDinoInstruction(!0),e.search=!0;var n=o[0].geometry.location;return map.setCenter(n),map.setZoom(5),personMarker=new google.maps.Marker({map:map,position:n,icon:"img/manSm.png"}),e.location(""),e.locationInstruction(!1),e.showLegend(!0),person=!0,n}return e.startLoc})}),e.toggleDinos=function(){switch(e.filterDinoInstruction(!1),e.dinoListInstruction(!0),e.activeInfowindow()&&e.activeInfowindow().close(),arguments[0]){case"omnivore":var o=e.omnivoreMarkers();e.display(o);break;case"carnivore":o=e.carnivoreMarkers(),e.display(o);break;case"herbivore":o=e.herbivoreMarkers(),e.display(o);break;case"all":}},e.display=function(o){if(o[0].visible===!1||o[2].visible===!1)for(var i=0;i<o.length;i++){var n=o[i];n.setVisible(!0)}else(o[0].visible===!0||o[2].visible===!0)&&e.hide(o)},e.hide=function(e){for(var o=0;o<e.length;o++){var i=e[o];i.setVisible(!1)}},e.displayThisDino=function(){e.activeInfowindow()&&e.activeInfowindow().close(),e.hide(e.omnivoreMarkers()),e.hide(e.carnivoreMarkers()),e.hide(e.herbivoreMarkers());for(var o=arguments[0].name,i=e.dinoList(),n=i.length,a=0;n>a;a++){var r=i[a],t=i[a].markers()[0];if(o===r.name){t.setVisible(!0),map.panTo(t.position);break}}},e.init()};ko.bindingHandlers.fadeVisible={init:function(e,o){var i=o();$(e).toggle(ko.unwrap(i))},update:function(e,o){var i=o();ko.unwrap(i)?$(e).fadeIn():$(e).fadeOut()}},ko.applyBindings(new ViewModel);